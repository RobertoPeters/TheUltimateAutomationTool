@using Microsoft.Agents.AI
@using Microsoft.Extensions.AI
@using Radzen
@using Radzen.Blazor
@using System.Text
@using Tuat.Interfaces
@using Tuat.Models
@implements IDisposable
@inject IAIConversationService AIConversationService
@inject NavigationManager NavigationManager
@inject IDataService DataService;

<RadzenSplitter Orientation="Radzen.Orientation.Vertical" style="width: 100%;height: 95vh">
	<RadzenSplitterPane Size="40vh" Min="300px">
		<RadzenMarkdown Style="width:100%;height:100%;overflow:auto;" Text="@agentResponse.ToString()" />
	</RadzenSplitterPane>
	<RadzenSplitterPane Min="100px">
		<RadzenDropDown TValue="AIConversation" Data="@aIConversations" @bind-Value="selectedAIConversation" TextProperty="@nameof(AIConversation.Name)" Change="@AIConversationChange" />
		<RadzenTextArea Style="width:100%;height:20vh" @bind-Value="prompt" />
		<RadzenButton Text="New Chat" Click="async () => NewChat()" Style="margin-top:10px" Disabled="@(selectedAIConversation == null || string.IsNullOrWhiteSpace(prompt))" />
		<RadzenButton Text="Stop" Click="async () => Stop()" Style="margin-top:10px" Disabled="@(cancellationTokenSource == null)" />
		<RadzenButton Text="Continue Chat" Click="async () => ContinueChat()" Style="margin-top:10px" Disabled="@(cancellationTokenSource != null || selectedAIConversation == null || string.IsNullOrWhiteSpace(prompt) || latestReceivedUpdate == null || thread == null)" />
	</RadzenSplitterPane>
</RadzenSplitter>


@code {
	[Parameter]
	public IAutomationHandler? AutomationHandler { get; set; }

	[Parameter]
	public Type? ScriptEngineType { get; set; }

	[Parameter]
	public List<object>? Tools { get; set; }

	[Parameter]
	public string? SystemCode { get; set; }

	[Parameter]
	public string? UserCode { get; set; }

	[Parameter]
	public string? ConversationAgentInstructions { get; set; }

	private sealed class ConversationState
	{
		public int? SelectedConversationId { get; set; }
		public string? AgentResponse { get; set; }
		public System.Text.Json.JsonElement? Thread { get; set; }
		public string? LatestReceivedUpdate { get; set; }
	}

	ConversationState? conversationState;
	List<AIConversation> aIConversations = null!;
	AIConversation? selectedAIConversation;
	CancellationTokenSource? cancellationTokenSource;
	string prompt = "";
	StringBuilder agentResponse = new();
	AgentRunResponseUpdate? latestReceivedUpdate = null;
	AgentThread? thread = null;

	protected override void OnInitialized()
	{
		aIConversations = DataService.GetAIConversations().ToList();
		LoadConversationState();
		base.OnInitialized();
	}

	public void Dispose()
	{
		Stop();
	}

	void Stop()
	{
		cancellationTokenSource?.Cancel();
		cancellationTokenSource = null;
	}

	string GetConversationFileName()
	{
		var relUriPath = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
		var basePath = System.IO.Path.Combine("Settings", "ConversationStates");
		if (!System.IO.Directory.Exists(basePath))
		{
			System.IO.Directory.CreateDirectory(basePath);
		}
		return System.IO.Path.Combine(basePath, $"v1_{relUriPath.GetHashCode().ToString().Replace("-", "")}.json");
	}

	void LoadConversationState()
	{
		try
		{
			string filename = GetConversationFileName();
			if (System.IO.File.Exists(filename))
			{
				var fileContent = System.IO.File.ReadAllText(filename);
				conversationState = System.Text.Json.JsonSerializer.Deserialize<ConversationState>(fileContent);
				if (conversationState != null)
				{
					if (conversationState.SelectedConversationId.HasValue)
					{
						selectedAIConversation = aIConversations.FirstOrDefault(x => x.Id == conversationState.SelectedConversationId.Value);
					}
					if (!string.IsNullOrWhiteSpace(conversationState.AgentResponse))
					{
						agentResponse = new StringBuilder(conversationState.AgentResponse);
					}
					if (!string.IsNullOrWhiteSpace(conversationState.LatestReceivedUpdate))
					{
						latestReceivedUpdate = System.Text.Json.JsonSerializer.Deserialize<AgentRunResponseUpdate>(conversationState.LatestReceivedUpdate);
					}
				}
			}
	}
		catch
		{

		}
	}

	void SaveConversationState()
	{
		try
		{
			var conversationState = new ConversationState
			{
				SelectedConversationId = selectedAIConversation?.Id,
				AgentResponse = agentResponse?.ToString(),
				Thread = thread?.Serialize(),
				LatestReceivedUpdate = latestReceivedUpdate?.RawRepresentation == null ? null : System.Text.Json.JsonSerializer.Serialize(latestReceivedUpdate.RawRepresentation)
			};

			string filename = GetConversationFileName();
			System.IO.File.WriteAllText(filename, System.Text.Json.JsonSerializer.Serialize(conversationState));
		}
		catch
		{

		}
	}

	public void RunConversation()
	{
		Stop();
		var inputPrompt = AddPromptToConversation();
		cancellationTokenSource = new CancellationTokenSource();
		var options = new AgentRunOptions
		{
			AllowBackgroundResponses = true,
			ContinuationToken = latestReceivedUpdate?.ContinuationToken
		};
		latestReceivedUpdate = null;
		var agent = AIConversationService.CreateAIConversationAgent(selectedAIConversation!.Id, ScriptEngineType, AutomationHandler, UserCode, SystemCode, Tools, ConversationAgentInstructions, FunctionCallMiddleware);
		if (conversationState?.Thread != null)
		{
			thread = agent.DeserializeThread(conversationState.Thread.Value);
		}
		thread ??= agent.GetNewThread();
		Task.Factory.StartNew(async () =>
		{
			await foreach (AgentRunResponseUpdate update in agent.RunStreamingAsync(inputPrompt, thread: thread, options: options, cancellationToken: cancellationTokenSource.Token))
			{
				if (cancellationTokenSource != null)
				{
					latestReceivedUpdate = update;
					agentResponse.Append(update.Text);
					SaveConversationState();
					await InvokeAsync(StateHasChanged);
				}
			}
			cancellationTokenSource = null;
			await InvokeAsync(StateHasChanged);
			SaveConversationState();
		});
	}

	public void ContinueChat()
	{
		RunConversation();
	}

	void AIConversationChange()
	{
		thread = null;
		latestReceivedUpdate = null;
		agentResponse = new();
	}

	public void NewChat()
	{
		thread = null;
		latestReceivedUpdate = null;
		agentResponse = new();
		conversationState = null;
		RunConversation();
	}

	string AddPromptToConversation()
	{
		var inputPrompt = prompt;
		agentResponse.AppendLine();
		agentResponse.AppendLine();
		agentResponse.AppendLine($"> *{prompt}*");
		agentResponse.AppendLine();
		agentResponse.AppendLine();
		prompt = "";
		return inputPrompt;
	}

	async ValueTask<object?> FunctionCallMiddleware(AIAgent callingAgent, FunctionInvocationContext context, Func<FunctionInvocationContext, CancellationToken, ValueTask<object?>> next, CancellationToken cancellationToken)
	{
		StringBuilder functionCallDetails = new();
		functionCallDetails.Append($"- Tool Call: '{context.Function.Name}' [Agent: {callingAgent.Name}]");
		if (context.Arguments.Count > 0)
		{
			functionCallDetails.Append($" (Args: {string.Join(",", context.Arguments.Select(x => $"[{x.Key} = {x.Value}]"))}");
		}

		System.Diagnostics.Debugger.Log(0, null, functionCallDetails.ToString());

		return await next(context, cancellationToken);
	}
}
