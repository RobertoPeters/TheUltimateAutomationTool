@using Radzen
@using Radzen.Blazor
@using Tuat.Dialogs
@using Tuat.Interfaces
@using Tuat.Models

@inherits ResultDialogBase<Transition>

<RadzenTemplateForm @ref="Form" Data="@Model" TItem="Transition">
    <RadzenStack>
        <RadzenFormField Text="Description" Variant="@Variant.Outlined">
            <RadzenTextArea @bind-Value="@Model!.Description" Name="Description" Rows="3" spellcheck="false" />
        </RadzenFormField>
        <RadzenFormField Text="Condition" Variant="@Variant.Outlined">
            <ScriptEditor @ref="scriptEditor"
                          ScriptEditorType="@ScriptEditorType"
                          Script="@(Transition?.Condition)"
                          ScriptEngine="@ScriptEngine"
                          Height="50vh" />
        </RadzenFormField>
    </RadzenStack>
    <RadzenButton ButtonType="ButtonType.Button" Text="OK" Click="@OnSubmit" />
</RadzenTemplateForm>


@code {
    protected override bool ShowClose => true;
    protected override bool IsPersistent => false;
    protected override bool CloseDialogOnOverlayClick => true;
    protected override int? WidthInPixels => 1400;

    [Parameter]
    public Type? ScriptEditorType { get; set; }

    [Parameter]
    public IScriptEngine? ScriptEngine { get; set; }

    [Parameter]
    public Transition? Transition { get; set; }

    [Parameter]
    public Automation? Automation { get; set; }

    private Transition? Model;
    private RadzenTemplateForm<Transition>? Form;
    ScriptEditor? scriptEditor;


    protected override void OnInitialized()
    {
        if (Transition == null)
        {
            Transition = new Transition();
        }
        Model = Transition.CopyObject();        
        base.OnInitialized();
    }

    async Task OnSubmit()
    {
        Form!.EditContext.Validate();
        if (Form.IsValid)
        {
            Model!.Condition = await scriptEditor!.GetScriptAsync();
            Close(Model);
        }
    }
}
