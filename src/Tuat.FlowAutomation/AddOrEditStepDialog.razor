@using Radzen
@using Radzen.Blazor
@using Tuat.Dialogs
@using Tuat.Extensions
@using Tuat.Interfaces
@using Tuat.Models
@inherits ResultDialogBase<Step>

@if (Model != null)
{
	<RadzenTemplateForm @ref="Form" Data="@Model" TItem="Step">
		<RadzenStack>
			<RadzenFormField Text="Name" Variant="@Variant.Outlined">
				<RadzenTextBox @bind-Value="@Model!.Name" Name="Name" spellcheck="false" />
			</RadzenFormField>
			<RadzenFormField Text="Type *" Variant="@Variant.Outlined">
				<ChildContent>
					<RadzenDropDown Data="Generic.StepTypeDisplayNames" Change="ChangeStepType" ValueProperty="TypeName" TextProperty="DisplayName" @bind-Value="@Model!.StepTypeName" Name="StepType" Disabled=@(!IsNew) />
				</ChildContent>
				<Helper>
					<RadzenRequiredValidator Component="StepType" Text="This field is required" />
				</Helper>
			</RadzenFormField>
			@if (!string.IsNullOrWhiteSpace(Model!.StepTypeName) && SettingsPropertiesParameters != null)
			{
				<DynamicComponent @ref="stepTypeProperties" Type="@(SettingsComponentType())" Parameters="SettingsPropertiesParameters" />
			}
			</RadzenStack>
			<RadzenButton ButtonType="ButtonType.Button" Text="OK" Click="@OnSubmit" />
		</RadzenTemplateForm>
}

@code {
	protected override bool ShowClose => true;
	protected override bool IsPersistent => false;
	protected override bool CloseDialogOnOverlayClick => true;
	protected override int? WidthInPixels => 1400;

	[Parameter]
	public Step? Step { get; set; }

	[Parameter]
	public Automation? Automation { get; set; }

	[Parameter]
	public Type? ScriptEditorType { get; set; }

	[Parameter]
	public IScriptEngine? ScriptEngine { get; set; }

	bool IsNew;
	Step? Model;
	RadzenTemplateForm<Step>? Form;
	DynamicComponent? stepTypeProperties;
	Dictionary<string, object?>? SettingsPropertiesParameters;

	protected override void OnInitialized()
	{
		if (Step == null)
		{
			IsNew = true;
			Step = new Step();
			Model = Step;
		}
		else
		{
			var stepInfo = Generic.StepTypeDisplayNames.First(x => x.TypeName == Step.StepTypeName);
			Model = (Step)Step.CopyObjectToOtherType(stepInfo.Type)!;
		}
		if (!IsNew)
		{
			SettingsPropertiesParameters = new Dictionary<string, object?>() { { "Model", Model }, { "ScriptEditorType", ScriptEditorType }, { "ScriptEngine", ScriptEngine }, { "Automation", Automation } };
		}
		base.OnInitialized();
	}

	Type? SettingsComponentType()
	{
		return string.IsNullOrWhiteSpace(Model?.StepTypeName) ? null : Generic.StepTypeDisplayNames.First(x => x.TypeName == Model.StepTypeName).SettingsEditorComponentType;
	}

	void ChangeStepType()
	{
		SettingsPropertiesParameters = null;
		if (!string.IsNullOrWhiteSpace(Model?.StepTypeName))
		{
			Model = (Step)Model.CopyObjectToOtherType(Generic.StepTypeDisplayNames.First(x => x.TypeName == Model.StepTypeName).Type)!;
			SettingsPropertiesParameters = new Dictionary<string, object?>() { { "Model", Model }, { "ScriptEditorType", ScriptEditorType }, { "ScriptEngine", ScriptEngine }, { "Automation", Automation } };
		}
	}

	async Task OnSubmit()
	{
		Form!.EditContext.Validate();
		if (Form.IsValid)
		{
			if (stepTypeProperties?.Instance is IStepSettings stepSettings)
			{
				await stepSettings.SaveChangesAsync();
			}
			Close(Model);
		}
	}

}
