@using Radzen.Blazor
@using System.Text
@using Tuat.Dialogs
@using Tuat.Interfaces
@using Tuat.Models
@inject IDataService DataService
@inject Tuat.Interfaces.IClientService ClientService

@if (ScriptEditorType != null)
{
	<DynamicComponent @ref="scriptEditor" Type="ScriptEditorType" Parameters="EditorPropertiesParameters" />
}

@code {
	[Parameter]
	public string Height { get; set; } = "200px";

	[Parameter]
	public string? Script { get; set; }

	[Parameter]
	public Type? ScriptEditorType { get; set; }

	[Parameter]
	public IScriptEngine? ScriptEngine { get; set; }

	[Parameter]
	public Automation? Automation { get; set; }

	[Parameter]
	public bool IncludePreStartScript { get; set; } = true;

	Dictionary<string, object?>? EditorPropertiesParameters;
	DynamicComponent? scriptEditor;

	protected override async Task OnInitializedAsync()
	{
		EditorPropertiesParameters = new Dictionary<string, object?>() { { "Script", Script }, { "SystemScript", GetSystemScript() }, { "Height", Height } };
		await base.OnInitializedAsync();
	}

	public async Task<string?> GetScriptAsync()
	{
		return await ((IScriptEditor)scriptEditor!.Instance!).GetScriptAsync();
	}

	string GetSystemScript()
	{
		if (Automation == null)
		{
			return "";
		}

		var result = new StringBuilder();

		if (Automation?.IncludeScriptId == null)
		{
			result.AppendLine(ScriptEngine?.GetSystemScript(ClientService) ?? "");
		}
		var additionalScript = Tuat.Helpers.LibraryScriptGenerator.GenerateScriptCode(DataService, Automation!.IncludeScriptId, null);
		result.AppendLine(ScriptEngine?.GetSystemScript(ClientService, additionalScript: additionalScript) ?? "");

		if (IncludePreStartScript)
		{
			var automationProperties = FlowHandler.GetAutomationProperties(Automation.Data);
			if (!string.IsNullOrWhiteSpace(automationProperties.PreStartAction))
			{
				result.AppendLine(automationProperties.PreStartAction);
			}
		}

		return result.ToString();
	}

}
