@using Tuat.Dialogs
@using Tuat.Extensions
@using Tuat.Models
@using Tuat.Interfaces
@inject IDataService DataService
@inherits DialogBase

@if (Model != null)
{
    <RadzenTemplateForm @ref="Form" Data="@Model" TItem="AIProvider">
        <RadzenStack>
            <RadzenFormField Text="Type *" Variant="@Variant.Outlined">
                <ChildContent>
                    <RadzenDropDown Data="Tuat.Helpers.Generics.Generic.AIProviderTypeDisplayNames" ValueProperty="TypeName" TextProperty="DisplayName" @bind-Value="@Model!.ProviderType" Name="ProviderType" Disabled=@((Id ?? 0) != 0) />
                </ChildContent>
                <Helper>
                    <RadzenRequiredValidator Component="ProviderType" Text="This field is required" />
                </Helper>
            </RadzenFormField>
            <RadzenFormField Text="Name *" Variant="@Variant.Outlined">
                <ChildContent>
                    <RadzenTextBox @bind-Value="@Model!.Name" Name="Name" Placeholder="name" spellcheck="false" />
                </ChildContent>
                <Helper>
                    <RadzenRequiredValidator Component="Name" Text="This field is required" />
                    <RadzenCustomValidator Component="Name" Validator="@(() => !ExistingAIProviderNames.Contains(Model!.Name))" Text="Name should be unique" />
                </Helper>
            </RadzenFormField>
            @if (!string.IsNullOrWhiteSpace(Model.ProviderType))
            {
                <DynamicComponent @ref="aiProviderProperties" Type="@(SettingsComponentType())" Parameters="SettingsPropertiesParameters" />
            }
            <RadzenButton ButtonType="ButtonType.Button" Text="OK" Click="@OnSubmit" />
        </RadzenStack>
    </RadzenTemplateForm>
}

@code {
    protected override bool ShowClose => true;
    protected override bool IsPersistent => false;
    protected override bool CloseDialogOnOverlayClick => true;
    protected override int? WidthInPixels => 1400;

    [Parameter]
    public int? Id { get; set; }

    [Parameter]
    public HashSet<string> ExistingAIProviderNames { get; set; } = [];

    private AIProvider? Model;
    private RadzenTemplateForm<AIProvider>? Form;
    private DynamicComponent? aiProviderProperties;
    Dictionary<string, object?>? SettingsPropertiesParameters;

    protected override void OnInitialized()
    {
        var allAIProviders = DataService.GetAIProviders();
        Id ??= 0;
        if (Id == 0)
        {
            Model = new();
        }
        else
        {
            Model = allAIProviders.First(x => x.Id == Id).CopyObject()!;
            Model.Id = Id.Value;
        }
        ExistingAIProviderNames = allAIProviders.Where(x => x.Id != Id).Select(x => x.Name).ToHashSet();
        SettingsPropertiesParameters = new Dictionary<string, object?>() {{ "Model", Model }};
        base.OnInitialized();
    }

    Type? SettingsComponentType()
    {
        return string.IsNullOrWhiteSpace(Model?.ProviderType) ? null : Tuat.Helpers.Generics.Generic.AIProviderTypeDisplayNames.First(x => x.TypeName == Model.ProviderType).SettingsEditorComponentType;
    }

    async Task OnSubmit()
    {
        Form!.EditContext.Validate();
        if (Form.IsValid)
        {
            Model!.Settings = ((IAIProviderSettings)aiProviderProperties!.Instance!).GetProviderPropertiesData() ?? "";
            await DataService.AddOrUpdateAIProviderAsync(Model);
            Close();
        }
    }
}
