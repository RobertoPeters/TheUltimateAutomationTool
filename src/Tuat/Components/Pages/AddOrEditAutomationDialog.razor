@using Tuat.Dialogs
@using Tuat.Extensions
@using Tuat.Models
@using Tuat.Interfaces
@inject IDataService DataService

@inherits ResultDialogBase<Automation>

<RadzenTemplateForm @ref="Form" Data="@Model" TItem="Automation">
    <RadzenStack>
        <RadzenFormField Text="Name *" Variant="@Variant.Outlined">
            <ChildContent>
                <RadzenTextBox @bind-Value="@Model.Name" Name="Name" spellcheck="false" />
            </ChildContent>
            <Helper>
                <RadzenRequiredValidator Component="Name" Text="This field is required" />
            </Helper>
        </RadzenFormField>
        <RadzenFormField Text="Type *" Variant="@Variant.Outlined">
            <ChildContent>
                <RadzenDropDown Data="Tuat.Helpers.Generics.Generic.AutomationTypeDisplayNames" ValueProperty="TypeName" TextProperty="DisplayName" @bind-Value="@Model.AutomationType" Name="AutomationType" Disabled=@(Model.Id != 0) />
            </ChildContent>
            <Helper>
                <RadzenRequiredValidator Component="AutomationType" Text="This field is required" />
            </Helper>
        </RadzenFormField>
        <RadzenFormField Text="Script language *" Variant="@Variant.Outlined">
            <ChildContent>
                <RadzenDropDown Data="Tuat.Helpers.Generics.Generic.ScriptTypeDisplayNames" ValueProperty="TypeName" TextProperty="DisplayName" @bind-Value="@Model.ScriptType" Name="ScriptType" Disabled=@(Model.Id != 0) />
            </ChildContent>
            <Helper>
                <RadzenRequiredValidator Component="ScriptType" Text="This field is required" />
            </Helper>
        </RadzenFormField>
        <RadzenFormField Text="Sub Automation" Variant="@Variant.Outlined">
            <RadzenRadioButtonList @bind-Value="@Model.IsSubAutomation" TValue="bool" class="rz-m-4 rz-mt-8">
                <Items>
                    <RadzenRadioButtonListItem Text="Yes" Value="true" />
                    <RadzenRadioButtonListItem Text="No" Value="false" />
                </Items>
            </RadzenRadioButtonList>
        </RadzenFormField>
        @if (!Model.IsSubAutomation)
        {
            <RadzenFormField Text="Enabled" Variant="@Variant.Outlined">
                <RadzenRadioButtonList @bind-Value="@Model.Enabled" TValue="bool" class="rz-m-4 rz-mt-8">
                    <Items>
                        <RadzenRadioButtonListItem Text="Yes" Value="true" />
                        <RadzenRadioButtonListItem Text="No" Value="false" />
                    </Items>
                </RadzenRadioButtonList>
            </RadzenFormField>
        }
        else
        {
            <RadzenFormField Text="Sub Automation Variables" Variant="@Variant.Outlined">
                <RadzenDataGrid Data="@Model.SubAutomationParameters"
                                TItem="SubAutomationParameter"
                                RowCreate="@OnCreateRow"
                                RowUpdate="@OnUpdateRow"
                                @ref=parametersGrid
                                EditMode="DataGridEditMode.Multiple">
                    <HeaderTemplate>
                        <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="add_circle" Text="Add Parameter" Click="@InsertRow" />
                    </HeaderTemplate>
                    <Columns>
                        <RadzenDataGridColumn Context="parameter" Width="150px" Resizable="false" Filterable="false" Sortable="false" TextAlign="TextAlign.Right" Frozen="true" FrozenPosition="FrozenColumnPosition.Left">
                            <Template Context="parameter">
                                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(args => EditRowAsync(parameter))" @onclick:stopPropagation="true" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" Size="ButtonSize.Medium" Shade="Shade.Lighter" class="rz-my-1 rz-ms-1" Click="@(args => DeleteRowAsync(parameter))" @onclick:stopPropagation="true" />
                            </Template>
                            <EditTemplate Context="parameter">
                                <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat" Size="ButtonSize.Medium" Click="@((args) => SaveRowAsync(parameter))" aria-label="Save" />
                                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@((args) => CancelEdit(parameter))" aria-label="Cancel" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" Size="ButtonSize.Medium" Shade="Shade.Lighter" class="rz-my-1 rz-ms-1" Click="@(args => DeleteRowAsync(parameter))" aria-label="Delete" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="Name" Title="Name">
                            <EditTemplate Context="parameter">
                                <RadzenTextBox Style="width:200px; display: block; border:solid;" @bind-Value="parameter.Name" Name="ParameterName" />
                                <RadzenRequiredValidator Text="Name is required" Component="ParameterName" Popup="true" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="ScriptVariableName" Title="Script Variable Name">
                            <EditTemplate Context="parameter">
                                <RadzenTextBox Style="width:200px; display: block; border:solid;" @bind-Value="parameter.ScriptVariableName" Name="ScriptVariableName" />
                                <RadzenRequiredValidator Text="Script variable name is required" Component="ScriptVariableName" Popup="true" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="DefaultValue" Title="Default Value">
                            <EditTemplate Context="parameter">
                                <RadzenTextBox Style="width:200px; display: block; border:solid;" @bind-Value="parameter.DefaultValue" Name="DefaultValue" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="SubStateMachineParameter" Title="Is input">
                            <Template Context="parameter">
                                @(parameter.IsInput ? "Yes" : "No")
                            </Template>
                            <EditTemplate Context="parameter">
                                <RadzenRadioButtonList @bind-Value="@parameter.IsInput" TValue="bool" class="rz-m-4 rz-mt-8">
                                    <Items>
                                        <RadzenRadioButtonListItem Text="Yes" Value="true" />
                                        <RadzenRadioButtonListItem Text="No" Value="false" />
                                    </Items>
                                </RadzenRadioButtonList>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Property="IsOutput" Title="Is output">
                            <Template Context="parameter">
                                @(parameter.IsOutput ? "Yes" : "No")
                            </Template>
                            <EditTemplate Context="parameter">
                                <RadzenRadioButtonList @bind-Value="@parameter.IsOutput" TValue="bool" class="rz-m-4 rz-mt-8">
                                    <Items>
                                        <RadzenRadioButtonListItem Text="Yes" Value="true" />
                                        <RadzenRadioButtonListItem Text="No" Value="false" />
                                    </Items>
                                </RadzenRadioButtonList>
                            </EditTemplate>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenFormField>
        }
        @if (!string.IsNullOrWhiteSpace(Model.AutomationType))
        {
            <DynamicComponent @ref="settingsProperties" Type="@(SettingsComponentType())" Parameters="SettingsPropertiesParameters" />
        }
    </RadzenStack>
    <RadzenButton ButtonType="ButtonType.Button" Text="OK" Click="@OnSubmit" />
</RadzenTemplateForm>


@code {
    protected override bool ShowClose => true;
    protected override bool IsPersistent => false;
    protected override bool CloseDialogOnOverlayClick => true;
    protected override int? WidthInPixels => 1400;

    [Parameter]
    public Automation? Automation { get; set; }

    private Automation Model = new();
    private RadzenTemplateForm<Automation>? Form;
    private DynamicComponent? settingsProperties;
    Dictionary<string, object?>? SettingsPropertiesParameters;
    private RadzenDataGrid<SubAutomationParameter>? parametersGrid;
    private readonly List<SubAutomationParameter> parametersToInsert = [];
    private readonly List<SubAutomationParameter> parametersToUpdate = [];

    protected override void OnInitialized()
    {
        if (Automation == null)
        {
            Automation = new Automation();
            Automation.Enabled = false;
        }
        Model = Automation.CopyObject()!;
        Model.Id = Automation.Id;
        SettingsPropertiesParameters = new Dictionary<string, object?>() { { "Model", Model } };
        base.OnInitialized();
    }

    Type? SettingsComponentType()
    {
        return string.IsNullOrWhiteSpace(Model?.AutomationType) ? null : Tuat.Helpers.Generics.Generic.AutomationTypeDisplayNames.First(x => x.TypeName == Model.AutomationType).SettingsEditorComponentType;
    }

    void OnSubmit()
    {
        Form!.EditContext.Validate();
        if (Form.IsValid)
        {
            Model!.Settings = ((IAutomationSettings)settingsProperties!.Instance!).GetAutomationPropertiesData() ?? "";
            Close(Model!);
        }
    }

    void Reset()
    {
        parametersToInsert.Clear();
        parametersToUpdate.Clear();
    }

    void Reset(SubAutomationParameter parameter)
    {
        parametersToInsert.Remove(parameter);
        parametersToUpdate.Remove(parameter);
    }

    async Task InsertRow()
    {
        if (!parametersGrid!.IsValid) return;

        var parameter = new SubAutomationParameter();
        parametersToInsert.Add(parameter);
        await parametersGrid.InsertRow(parameter);
    }

    void OnCreateRow(SubAutomationParameter parameter)
    {
        Model!.SubAutomationParameters.Add(parameter);
        parametersToInsert.Remove(parameter);
    }

    void OnUpdateRow(SubAutomationParameter parameter)
    {
        Reset(parameter);
        var index = Model!.SubAutomationParameters.FindIndex(x => x.Id == parameter.Id);
        if (index >= 0)
        {
            Model.SubAutomationParameters[index] = parameter;
        }
    }

    async Task EditRowAsync(SubAutomationParameter parameter)
    {
        if (!parametersGrid!.IsValid) return;

        parametersToUpdate.Add(parameter);
        await parametersGrid.EditRow(parameter);
    }

    async Task SaveRowAsync(SubAutomationParameter parameter)
    {
        await parametersGrid!.UpdateRow(parameter);
    }

    void CancelEdit(SubAutomationParameter parameter)
    {
        Reset(parameter);

        parametersGrid!.CancelEditRow(parameter);
    }

    async Task DeleteRowAsync(SubAutomationParameter parameter)
    {
        Reset(parameter);

        if (Model!.SubAutomationParameters.Contains(parameter))
        {
            Model.SubAutomationParameters.Remove(parameter);
        }
        else
        {
            parametersGrid!.CancelEditRow(parameter);
        }
        await parametersGrid!.Reload();
    }

}
