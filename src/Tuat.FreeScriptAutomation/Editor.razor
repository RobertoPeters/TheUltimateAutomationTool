@using Radzen
@using Radzen.Blazor
@using Tuat.Interfaces
@using Tuat.Models
@inject Tuat.Interfaces.IClientService ClientService
@implements IAutomationEditor

@if (ScriptEditorType != null)
{
 	<RadzenButton Size="ButtonSize.ExtraSmall" Text="Edit properties" Click="EditSettingsAsync" />
	<RadzenButton Size="ButtonSize.ExtraSmall" Text="Save" Click="SaveAsync" />
	<RadzenButton Size="ButtonSize.ExtraSmall" Text="Restart" Click="Restart" />
	<RadzenSplitter Orientation="Radzen.Orientation.Horizontal" style="width: 98%;">
		<RadzenSplitterPane Min="10px">
			<DynamicComponent @ref="scriptEditor" Type="ScriptEditorType" Parameters="EditorPropertiesParameters" />
		</RadzenSplitterPane>
		<RadzenSplitterPane Size="300px" Min="10px">
			<DynamicComponent Type="ScriptEditorType" Parameters="SystemScriptParameters" />
		</RadzenSplitterPane>
	</RadzenSplitter>
}

@code {
	[Parameter]
	public Automation Automation { get; set; } = null!;

	[Parameter]
	public string? Height { get; set; }

	[Parameter]
	public Type? ScriptEditorType { get; set; }

	[Parameter]
	public EventCallback OnRestart { get; set; }

	[Parameter]
	public EventCallback OnSave { get; set; }

	[Parameter]
	public EventCallback OnEditSettings { get; set; }

	Dictionary<string, object?>? EditorPropertiesParameters;
	Dictionary<string, object?>? SystemScriptParameters;
	DynamicComponent? scriptEditor;
	AutomationProperties automationProperties = null!;

	protected override async Task OnInitializedAsync()
	{
		automationProperties = FreeScriptHandler.GetAutomationProperties(Automation.Data);
		using var scriptEngine = FreeScriptHandler.GetScriptEngine(Automation.ScriptType);
		if (string.IsNullOrWhiteSpace(Automation.Data))
		{
			automationProperties.Script = scriptEngine?.GetDeclareFunction("schedule", null) ?? "";
		}
		EditorPropertiesParameters = new Dictionary<string, object?>() { { "Script", automationProperties.Script }, { "Height", Height ?? "85vh" } };
		SystemScriptParameters = new Dictionary<string, object?>() { { "Script", scriptEngine?.GetSystemScript(ClientService) ?? "" }, { "Height", Height ?? "85vh" }, { "ReadOnly", true } };
		await base.OnInitializedAsync();
	}

	public async Task ReloadAutomationAsync(Automation automation)
	{
		Automation = automation;
		automationProperties = FreeScriptHandler.GetAutomationProperties(Automation.Data);
		using var scriptEngine = FreeScriptHandler.GetScriptEngine(Automation.ScriptType);
		if (string.IsNullOrWhiteSpace(Automation.Data))
		{
			automationProperties.Script = scriptEngine?.GetDeclareFunction("schedule", null) ?? "";
		}
		await ((IScriptEditor)scriptEditor!.Instance!).SetScriptAsync(automationProperties.Script);
	}

	async Task EditSettingsAsync()
	{
		automationProperties.Script = await ((IScriptEditor)scriptEditor!.Instance!).GetScriptAsync() ?? "";
		Automation.Data = System.Text.Json.JsonSerializer.Serialize(automationProperties);
		await OnEditSettings.InvokeAsync();
		await InvokeAsync(StateHasChanged);
	}

	void Restart()
	{
		OnRestart.InvokeAsync();
	}

	public async Task<string> GetAutomationDataAsync()
	{
		automationProperties.Script = await ((IScriptEditor)scriptEditor!.Instance!).GetScriptAsync() ?? "";
		return System.Text.Json.JsonSerializer.Serialize(automationProperties);
	}

	async Task SaveAsync()
	{
		await OnSave.InvokeAsync();
	}

}

