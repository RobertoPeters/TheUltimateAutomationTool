@using Radzen
@using Radzen.Blazor
@using Tuat.Interfaces
@using Tuat.Models
@inject IDataService DataService
@inject Tuat.Interfaces.IClientService ClientService
@implements IAutomationEditor

@if (ScriptEditorType != null)
{
 	<RadzenButton Size="ButtonSize.ExtraSmall" Text="Edit properties" Click="EditSettingsAsync" />
	<RadzenButton Size="ButtonSize.ExtraSmall" Text="Save" Click="SaveAsync" />
	<RadzenButton Size="ButtonSize.ExtraSmall" Text="Restart" Click="Restart" />
	<DynamicComponent @ref="scriptEditor" Type="ScriptEditorType" Parameters="EditorPropertiesParameters" />
}

@code {
	[Parameter]
	public Automation Automation { get; set; } = null!;

	[Parameter]
	public string? Height { get; set; }

	[Parameter]
	public Type? ScriptEditorType { get; set; }

	[Parameter]
	public EventCallback OnRestart { get; set; }

	[Parameter]
	public EventCallback OnSave { get; set; }

	[Parameter]
	public EventCallback OnEditSettings { get; set; }

	Dictionary<string, object?>? EditorPropertiesParameters;
	DynamicComponent? scriptEditor;
	AutomationProperties automationProperties = null!;

	protected override async Task OnInitializedAsync()
	{
		automationProperties = FreeScriptHandler.GetAutomationProperties(Automation.Data);
		using var scriptEngine = FreeScriptHandler.GetScriptEngine(Automation.ScriptType);
		if (string.IsNullOrWhiteSpace(Automation.Data))
		{
			automationProperties.Script = scriptEngine?.GetDeclareFunction("schedule", null) ?? "";
		}
		EditorPropertiesParameters = new Dictionary<string, object?>() 
		{ 
			{ "Script", automationProperties.Script },
			{ "SystemScript", GetSystemScript(scriptEngine) }, 
			{ "Height", Height ?? "85vh" },
			{ "ConversationAgentInstructions", ConversationAgentInstructions}
		};
		await base.OnInitializedAsync();
	}

	string ConversationAgentInstructions => $""""
You are an expert automation using script.
The programming language is {Tuat.Helpers.Generics.Generic.ScriptTypeDisplayNames.FirstOrDefault(x => x.EditorComponentType == ScriptEditorType)?.DisplayName}.
The method or function 'schedule()' is called periodically and is mandatory to be available.
First check if the question is related to system code like timers, variable creating, etc., if so, answer according to that.
"""";

	string GetSystemScript(IScriptEngine? scriptEngine)
	{
		if (Automation?.IncludeScriptId == null)
		{
			return scriptEngine?.GetSystemScript(ClientService) ?? "";
		}
		var additionalScript = Tuat.Helpers.LibraryScriptGenerator.GenerateScriptCode(DataService, Automation.IncludeScriptId, null);
		return scriptEngine?.GetSystemScript(ClientService, additionalScript: additionalScript) ?? "";
	}

	public async Task ReloadAutomationAsync(Automation automation)
	{
		Automation = automation;
		automationProperties = FreeScriptHandler.GetAutomationProperties(Automation.Data);
		using var scriptEngine = FreeScriptHandler.GetScriptEngine(Automation.ScriptType);
		if (string.IsNullOrWhiteSpace(Automation.Data))
		{
			automationProperties.Script = scriptEngine?.GetDeclareFunction("schedule", null) ?? "";
		}
		await ((IScriptEditor)scriptEditor!.Instance!).SetScriptAsync(automationProperties.Script, GetSystemScript(scriptEngine));
	}

	async Task EditSettingsAsync()
	{
		automationProperties.Script = await ((IScriptEditor)scriptEditor!.Instance!).GetScriptAsync() ?? "";
		Automation.Data = System.Text.Json.JsonSerializer.Serialize(automationProperties);
		await OnEditSettings.InvokeAsync();
		await InvokeAsync(StateHasChanged);
	}

	void Restart()
	{
		OnRestart.InvokeAsync();
	}

	public async Task<string> GetAutomationDataAsync()
	{
		automationProperties.Script = await ((IScriptEditor)scriptEditor!.Instance!).GetScriptAsync() ?? "";
		return System.Text.Json.JsonSerializer.Serialize(automationProperties);
	}

	async Task SaveAsync()
	{
		await OnSave.InvokeAsync();
	}

}

